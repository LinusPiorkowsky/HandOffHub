<!-- templates/view_handoff.html -->
{% extends "base.html" %}
{% block title %}{{ handoff.title }} - HandoffHub{% endblock %}
{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6">
    <!-- Header -->
    <div class="border-b pb-4 mb-4">
        <h1 class="text-2xl font-bold text-gray-900">{{ handoff.title }}</h1>
        <div class="mt-2 flex items-center space-x-4 text-sm text-gray-600">
            <span>From: <strong>{{ handoff.from_team.name }}</strong></span>
            <span>To: <strong>{{ handoff.to_team.name }}</strong></span>
            <span>Created by: <strong>{{ handoff.creator.name }}</strong></span>
            <span>{{ handoff.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
    </div>

    <!-- Status and Actions -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-3">
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if handoff.status.value == 'pending' %}bg-yellow-100 text-yellow-800
                {% elif handoff.status.value == 'in_progress' %}bg-blue-100 text-blue-800
                {% elif handoff.status.value == 'completed' %}bg-green-100 text-green-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ handoff.status.value.replace('_', ' ').title() }}
            </span>
            
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if handoff.priority.value == 'urgent' %}bg-red-100 text-red-800
                {% elif handoff.priority.value == 'high' %}bg-orange-100 text-orange-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                Priority: {{ handoff.priority.value.title() }}
            </span>

            {% if handoff.is_overdue %}
            <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">OVERDUE</span>
            {% endif %}

            {% if handoff.deadline %}
            <span class="text-sm text-gray-600">
                Deadline: {{ handoff.deadline.strftime('%Y-%m-%d %H:%M') }}
            </span>
            {% endif %}
        </div>

        {% if current_user.team_id == handoff.to_team_id and handoff.status.value != 'completed' %}
        <form method="POST" action="{{ url_for('update_handoff_status', handoff_id=handoff.id) }}" class="flex space-x-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            {% if handoff.status.value == 'pending' %}
            <button type="submit" name="status" value="in_progress" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Start Working
            </button>
            {% endif %}
            
            {% if handoff.status.value == 'in_progress' %}
            <button type="submit" name="status" value="waiting_info" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                Need Info
            </button>
            <button type="submit" name="status" value="completed" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Mark Complete
            </button>
            {% endif %}
            
            {% if handoff.status.value == 'waiting_info' %}
            <button type="submit" name="status" value="in_progress" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Resume Work
            </button>
            {% endif %}
        </form>
        {% endif %}
    </div>

    <!-- Description -->
    <div class="mb-6">
        <h3 class="text-lg font-semibold mb-2">Description</h3>
        <div class="bg-gray-50 p-4 rounded">
            {{ handoff.description or 'No description provided.' }}
        </div>
    </div>

    <!-- Assignment Info -->
    {% if handoff.assignee %}
    <div class="mb-6 bg-blue-50 p-4 rounded">
        <strong>Assigned to:</strong> {{ handoff.assignee.name }} ({{ handoff.assignee.team.name }})
        {% if handoff.started_at %}
        <br><strong>Started:</strong> {{ handoff.started_at.strftime('%Y-%m-%d %H:%M') }}
        {% endif %}
    </div>
    {% endif %}

    <!-- Comments Section -->
    <div>
        <h3 class="text-lg font-semibold mb-4">Comments & Updates</h3>
        
        <!-- Add Comment Form -->
        <form method="POST" action="{{ url_for('add_comment', handoff_id=handoff.id) }}" class="mb-4">
            {{ form.hidden_tag() }}
            <div class="flex space-x-2">
                <textarea name="content" rows="2" class="flex-1 border rounded-lg px-3 py-2" placeholder="Add a comment..."></textarea>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Post</button>
            </div>
        </form>

        <!-- Comments List -->
        <div class="space-y-3">
            {% for comment in comments %}
            <div class="bg-gray-50 p-3 rounded">
                <div class="flex justify-between mb-1">
                    <span class="font-medium text-sm">{{ comment.user.name }}</span>
                    <span class="text-xs text-gray-500">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                <p class="text-gray-700">{{ comment.content }}</p>
            </div>
            {% else %}
            <p class="text-gray-500">No comments yet.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}