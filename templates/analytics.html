<!-- templates/analytics.html -->
{% extends "base.html" %}
{% block title %}Analytics - HandoffHub{% endblock %}
{% block content %}

<div class="space-y-6">
    <!-- Header with Date Range -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Analytics & Reports</h1>
                <p class="text-gray-600 mt-1">Track your team's performance and identify bottlenecks</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-2">
                <form method="GET" class="flex items-center space-x-2">
                    <input type="date" name="from" value="{{ date_from }}" 
                           class="px-3 py-2 border rounded-lg text-sm">
                    <span class="text-gray-500">to</span>
                    <input type="date" name="to" value="{{ date_to }}" 
                           class="px-3 py-2 border rounded-lg text-sm">
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Apply
                    </button>
                </form>
                <a href="{{ url_for('export_handoffs') }}" 
                   class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-download mr-2"></i>Export
                </a>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-paper-plane text-blue-600"></i>
                </div>
                <span class="text-2xl font-bold text-gray-900">{{ stats.total_sent }}</span>
            </div>
            <h3 class="text-sm font-medium text-gray-600">Handoffs Sent</h3>
            <p class="text-xs text-gray-500 mt-1">In selected period</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-inbox text-green-600"></i>
                </div>
                <span class="text-2xl font-bold text-gray-900">{{ stats.total_received }}</span>
            </div>
            <h3 class="text-sm font-medium text-gray-600">Handoffs Received</h3>
            <p class="text-xs text-gray-500 mt-1">In selected period</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-purple-600"></i>
                </div>
                <span class="text-2xl font-bold text-gray-900">{{ stats.completed }}</span>
            </div>
            <h3 class="text-sm font-medium text-gray-600">Completed</h3>
            <p class="text-xs text-gray-500 mt-1">{{ ((stats.completed / stats.total_received * 100) if stats.total_received else 0)|round(1) }}% completion rate</p>
        </div>

        <div class="bg-white rounded-xl shadow-sm border p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-hourglass-half text-yellow-600"></i>
                </div>
                <span class="text-2xl font-bold text-gray-900">{{ stats.avg_completion_hours }}h</span>
            </div>
            <h3 class="text-sm font-medium text-gray-600">Avg Completion Time</h3>
            <p class="text-xs text-gray-500 mt-1">Across all handoffs</p>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- By Priority Chart -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Handoffs by Priority</h3>
            <canvas id="priorityChart" height="300"></canvas>
        </div>

        <!-- By Type Chart -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Handoffs by Type</h3>
            <canvas id="typeChart" height="300"></canvas>
        </div>
    </div>

    <!-- Top Collaborators -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Collaborating Teams</h3>
        <div class="space-y-3">
            {% for collab in stats.top_collaborators %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-900">{{ collab.name }}</span>
                <div class="flex items-center">
                    <div class="w-32 bg-gray-200 rounded-full h-2 mr-3">
                        <div class="bg-indigo-600 h-2 rounded-full" 
                             style="width: {{ (collab.count / stats.top_collaborators[0].count * 100) if stats.top_collaborators else 0 }}%"></div>
                    </div>
                    <span class="text-sm font-semibold text-gray-600">{{ collab.count }} handoffs</span>
                </div>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-4">No collaboration data yet</p>
            {% endfor %}
        </div>
    </div>

    <!-- Team Members Performance -->
    <div class="bg-white rounded-xl shadow-sm border">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Team Member Performance</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Member</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completed</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">On-Time Rate</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for member in team_members %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold"
                                     style="background-color: {{ member.avatar_color }}">
                                    {{ member.get_initials() }}
                                </div>
                                <span class="ml-3 font-medium text-gray-900">{{ member.name }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ member.handoffs_completed }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">{{ member.average_completion_time|round(1) }}h</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ member.on_time_rate }}%"></div>
                                </div>
                                <span class="text-sm text-gray-900">{{ member.on_time_rate|round(1) }}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full 
                                {% if member.on_time_rate >= 90 %}bg-green-100 text-green-800
                                {% elif member.on_time_rate >= 70 %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {% if member.on_time_rate >= 90 %}Excellent
                                {% elif member.on_time_rate >= 70 %}Good
                                {% else %}Needs Improvement{% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Priority Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
new Chart(priorityCtx, {
    type: 'doughnut',
    data: {
        labels: {{ stats.by_priority.keys()|list|tojson }},
        datasets: [{
            data: {{ stats.by_priority.values()|list|tojson }},
            backgroundColor: [
                '#9CA3AF', // low - gray
                '#3B82F6', // medium - blue
                '#F59E0B', // high - yellow
                '#EF4444', // urgent - red
                '#991B1B'  // critical - dark red
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Type Chart
const typeCtx = document.getElementById('typeChart').getContext('2d');
new Chart(typeCtx, {
    type: 'bar',
    data: {
        labels: {{ stats.by_type.keys()|list|tojson }},
        datasets: [{
            label: 'Count',
            data: {{ stats.by_type.values()|list|tojson }},
            backgroundColor: '#6366F1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>

{% endblock %}
